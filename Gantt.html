import React, { useState, useRef, useEffect } from 'react';
import { Calendar, Plus, Edit2, Trash2, Save, X } from 'lucide-react';

const GanttTool = () => {
  const [tasks, setTasks] = useState([
    {
      id: 1,
      name: "Project Planning",
      startDate: "2024-09-05",
      endDate: "2024-09-12",
      color: "#3B82F6",
      progress: 75
    },
    {
      id: 2,
      name: "Design Phase",
      startDate: "2024-09-10",
      endDate: "2024-09-20",
      color: "#10B981",
      progress: 30
    },
    {
      id: 3,
      name: "Development",
      startDate: "2024-09-18",
      endDate: "2024-10-05",
      color: "#F59E0B",
      progress: 10
    }
  ]);

  const [showAddTask, setShowAddTask] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [newTask, setNewTask] = useState({
    name: '',
    startDate: '',
    endDate: '',
    color: '#3B82F6'
  });

  // Generate date range for timeline
  const generateDateRange = () => {
    const start = new Date('2024-09-01');
    const end = new Date('2024-10-31');
    const dates = [];
    const current = new Date(start);
    
    while (current <= end) {
      dates.push(new Date(current));
      current.setDate(current.getDate() + 1);
    }
    return dates;
  };

  const dates = generateDateRange();
  const totalDays = dates.length;

  // Calculate position and width for task bars
  const getTaskBarStyle = (task) => {
    const startDate = new Date(task.startDate);
    const endDate = new Date(task.endDate);
    const chartStart = dates[0];
    
    const startDay = Math.floor((startDate - chartStart) / (1000 * 60 * 60 * 24));
    const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    const leftPercent = (startDay / totalDays) * 100;
    const widthPercent = (duration / totalDays) * 100;
    
    return {
      left: `${leftPercent}%`,
      width: `${widthPercent}%`,
      backgroundColor: task.color
    };
  };

  const addTask = () => {
    if (newTask.name && newTask.startDate && newTask.endDate) {
      const task = {
        ...newTask,
        id: Date.now(),
        progress: 0
      };
      setTasks([...tasks, task]);
      setNewTask({ name: '', startDate: '', endDate: '', color: '#3B82F6' });
      setShowAddTask(false);
    }
  };

  const updateTask = () => {
    setTasks(tasks.map(t => t.id === editingTask.id ? editingTask : t));
    setEditingTask(null);
  };

  const deleteTask = (id) => {
    setTasks(tasks.filter(t => t.id !== id));
  };

  const formatDate = (dateStr) => {
    return new Date(dateStr).toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric' 
    });
  };

  const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <Calendar className="w-8 h-8 text-blue-600" />
              <h1 className="text-3xl font-bold text-gray-900">Gantt Chart</h1>
            </div>
            <button
              onClick={() => setShowAddTask(true)}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
            >
              <Plus className="w-4 h-4" />
              <span>Add Task</span>
            </button>
          </div>
        </div>

        {/* Add Task Modal */}
        {showAddTask && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-md">
              <h3 className="text-lg font-semibold mb-4">Add New Task</h3>
              <div className="space-y-4">
                <input
                  type="text"
                  placeholder="Task name"
                  value={newTask.name}
                  onChange={(e) => setNewTask({...newTask, name: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="date"
                  value={newTask.startDate}
                  onChange={(e) => setNewTask({...newTask, startDate: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="date"
                  value={newTask.endDate}
                  onChange={(e) => setNewTask({...newTask, endDate: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div className="flex space-x-2">
                  {colors.map(color => (
                    <button
                      key={color}
                      onClick={() => setNewTask({...newTask, color})}
                      className={`w-8 h-8 rounded-full border-2 ${
                        newTask.color === color ? 'border-gray-800' : 'border-gray-300'
                      }`}
                      style={{ backgroundColor: color }}
                    />
                  ))}
                </div>
              </div>
              <div className="flex space-x-3 mt-6">
                <button
                  onClick={addTask}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                >
                  <Save className="w-4 h-4" />
                  <span>Save</span>
                </button>
                <button
                  onClick={() => {
                    setShowAddTask(false);
                    setNewTask({ name: '', startDate: '', endDate: '', color: '#3B82F6' });
                  }}
                  className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Task Modal */}
        {editingTask && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-6 w-full max-w-md">
              <h3 className="text-lg font-semibold mb-4">Edit Task</h3>
              <div className="space-y-4">
                <input
                  type="text"
                  value={editingTask.name}
                  onChange={(e) => setEditingTask({...editingTask, name: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="date"
                  value={editingTask.startDate}
                  onChange={(e) => setEditingTask({...editingTask, startDate: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="date"
                  value={editingTask.endDate}
                  onChange={(e) => setEditingTask({...editingTask, endDate: e.target.value})}
                  className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <div>
                  <label className="block text-sm font-medium mb-2">Progress: {editingTask.progress}%</label>
                  <input
                    type="range"
                    min="0"
                    max="100"
                    value={editingTask.progress}
                    onChange={(e) => setEditingTask({...editingTask, progress: parseInt(e.target.value)})}
                    className="w-full"
                  />
                </div>
                <div className="flex space-x-2">
                  {colors.map(color => (
                    <button
                      key={color}
                      onClick={() => setEditingTask({...editingTask, color})}
                      className={`w-8 h-8 rounded-full border-2 ${
                        editingTask.color === color ? 'border-gray-800' : 'border-gray-300'
                      }`}
                      style={{ backgroundColor: color }}
                    />
                  ))}
                </div>
              </div>
              <div className="flex space-x-3 mt-6">
                <button
                  onClick={updateTask}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                >
                  <Save className="w-4 h-4" />
                  <span>Update</span>
                </button>
                <button
                  onClick={() => setEditingTask(null)}
                  className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Gantt Chart */}
        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
          {/* Timeline Header */}
          <div className="flex border-b bg-gray-50">
            <div className="w-64 p-4 font-semibold text-gray-700 border-r">
              Tasks
            </div>
            <div className="flex-1 overflow-x-auto">
              <div className="flex" style={{ minWidth: '800px' }}>
                {dates.filter((_, index) => index % 7 === 0).map((date, index) => (
                  <div
                    key={index}
                    className="flex-1 p-2 text-center text-sm font-medium text-gray-600 border-r"
                  >
                    {date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Task Rows */}
          {tasks.map((task) => (
            <div key={task.id} className="flex border-b hover:bg-gray-50 group">
              {/* Task Info */}
              <div className="w-64 p-4 border-r">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium text-gray-900">{task.name}</div>
                    <div className="text-sm text-gray-500">
                      {formatDate(task.startDate)} - {formatDate(task.endDate)}
                    </div>
                    <div className="text-xs text-gray-400 mt-1">
                      Progress: {task.progress}%
                    </div>
                  </div>
                  <div className="opacity-0 group-hover:opacity-100 flex space-x-1 transition-opacity">
                    <button
                      onClick={() => setEditingTask(task)}
                      className="p-1 text-gray-400 hover:text-blue-600"
                    >
                      <Edit2 className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => deleteTask(task.id)}
                      className="p-1 text-gray-400 hover:text-red-600"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>

              {/* Timeline */}
              <div className="flex-1 p-4 relative overflow-x-auto">
                <div className="relative h-8" style={{ minWidth: '800px' }}>
                  {/* Grid lines */}
                  {dates.filter((_, index) => index % 7 === 0).map((_, index) => (
                    <div
                      key={index}
                      className="absolute top-0 bottom-0 border-l border-gray-200"
                      style={{ left: `${(index * 100) / (totalDays / 7)}%` }}
                    />
                  ))}
                  
                  {/* Task Bar */}
                  <div
                    className="absolute top-1 bottom-1 rounded-md shadow-sm cursor-pointer hover:shadow-md transition-shadow"
                    style={getTaskBarStyle(task)}
                    onClick={() => setEditingTask(task)}
                  >
                    {/* Progress Bar */}
                    <div
                      className="h-full bg-black bg-opacity-20 rounded-md"
                      style={{ width: `${task.progress}%` }}
                    />
                    
                    {/* Task Name on Bar */}
                    <div className="absolute inset-0 flex items-center px-2">
                      <span className="text-white text-xs font-medium truncate">
                        {task.name}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}

          {/* Empty State */}
          {tasks.length === 0 && (
            <div className="p-12 text-center">
              <Calendar className="w-12 h-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-500 mb-2">No tasks yet</h3>
              <p className="text-gray-400 mb-4">Get started by adding your first task</p>
              <button
                onClick={() => setShowAddTask(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
              >
                Add Task
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default GanttTool;
